<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Importar Datos - School Project</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 20px;
      }

      .container {
        background: white;
        border-radius: 20px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        padding: 40px;
        max-width: 800px;
        width: 100%;
      }

      h1 {
        text-align: center;
        color: #333;
        margin-bottom: 10px;
        font-size: 2em;
      }

      .subtitle {
        text-align: center;
        color: #666;
        margin-bottom: 40px;
        font-size: 0.9em;
      }

      .buttons-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 15px;
        margin-bottom: 30px;
      }

      .btn-import {
        padding: 20px;
        border: none;
        border-radius: 12px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        color: white;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .btn-usuarios {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      }
      .btn-notas {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      }
      .btn-cursos {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
      }
      .btn-asistencias {
        background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
      }
      .btn-profesores {
        background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
      }

      .btn-import:hover {
        transform: translateY(-3px);
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
      }

      .btn-import:active {
        transform: translateY(-1px);
      }

      .upload-area {
        display: none;
        margin-top: 20px;
        padding: 30px;
        border: 3px dashed #667eea;
        border-radius: 12px;
        text-align: center;
        background: #f8f9ff;
        transition: all 0.3s ease;
      }

      .upload-area.active {
        display: block;
        animation: fadeIn 0.3s ease;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(-10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .upload-area h3 {
        color: #667eea;
        margin-bottom: 15px;
      }

      .file-input-wrapper {
        position: relative;
        display: inline-block;
        margin: 20px 0;
      }

      input[type="file"] {
        display: none;
      }

      .file-input-label {
        display: inline-block;
        padding: 12px 30px;
        background: #667eea;
        color: white;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s ease;
      }

      .file-input-label:hover {
        background: #764ba2;
        transform: scale(1.05);
      }

      .file-name {
        margin-top: 15px;
        color: #666;
        font-style: italic;
      }

      .btn-upload {
        margin-top: 20px;
        padding: 12px 40px;
        background: #43e97b;
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .btn-upload:hover {
        background: #38f9d7;
        transform: scale(1.05);
      }

      .btn-upload:disabled {
        background: #ccc;
        cursor: not-allowed;
        transform: scale(1);
      }

      .progress-container {
        display: none;
        margin-top: 20px;
      }

      .progress-bar {
        width: 100%;
        height: 30px;
        background: #e0e0e0;
        border-radius: 15px;
        overflow: hidden;
      }

      .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
        width: 0%;
        transition: width 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 600;
      }

      .status-message {
        margin-top: 15px;
        padding: 15px;
        border-radius: 8px;
        display: none;
      }

      .status-message.success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }

      .status-message.error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }

      .status-message.info {
        background: #d1ecf1;
        color: #0c5460;
        border: 1px solid #bee5eb;
      }

      .back-btn {
        margin-top: 20px;
        padding: 10px 20px;
        background: #6c757d;
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
      }

      .back-btn:hover {
        background: #5a6268;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>School Project</h1>
      <p class="subtitle">Sistema de Importaciï¿½n de Datos</p>

      <div class="buttons-grid">
        <button
          class="btn-import btn-usuarios"
          onclick="showUpload('usuarios')"
        >
          Usuarios
        </button>
        <button class="btn-import btn-notas" onclick="showUpload('notas')">
          Notas
        </button>
        <button class="btn-import btn-cursos" onclick="showUpload('cursos')">
          Cursos
        </button>
        <button
          class="btn-import btn-asistencias"
          onclick="showUpload('asistencias')"
        >
          Asistencias
        </button>
        <button
          class="btn-import btn-profesores"
          onclick="showUpload('profesores')"
        >
          Profesores
        </button>
      </div>

      <div id="uploadArea" class="upload-area">
        <h3 id="uploadTitle">Subir Archivo</h3>
        <p>Selecciona un archivo Excel (.xlsx, .xls, .csv)</p>

        <div class="file-input-wrapper">
          <input
            type="file"
            id="fileInput"
            accept=".xlsx,.xls,.csv"
            onchange="handleFileSelect(event)"
          />
          <label for="fileInput" class="file-input-label">
            Seleccionar Archivo
          </label>
        </div>

        <div id="fileName" class="file-name"></div>

        <button
          id="uploadBtn"
          class="btn-upload"
          onclick="processFile()"
          disabled
        >
          Subir y Procesar
        </button>

        <div id="progressContainer" class="progress-container">
          <div class="progress-bar">
            <div id="progressFill" class="progress-fill">0%</div>
          </div>
        </div>

        <div id="statusMessage" class="status-message"></div>

        <button class="back-btn" onclick="hideUpload()">ï¿½ Volver</button>
      </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
      import {
        getFirestore,
        collection,
        addDoc,
        setDoc,
        doc,
      } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

      // Configuraciï¿½n de Firebase
      const firebaseConfig = {
        apiKey: "AIzaSyDSQVrYXebAwfGPNL83sGEMjO2R3TL9qM4",
        authDomain: "school-project-c4ac2.firebaseapp.com",
        projectId: "school-project-c4ac2",
        storageBucket: "school-project-c4ac2.firebasestorage.app",
        messagingSenderId: "46224744303",
        appId: "1:46224744303:android:e05fb69c8d8d400530929a",
      };

      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);

      window.db = db;
      window.addDoc = addDoc;
      window.setDoc = setDoc;
      window.doc = doc;
      window.collection = collection;
    </script>

    <!-- SheetJS Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <script>
      let currentType = "";
      let selectedFile = null;

      function showUpload(type) {
        currentType = type;
        const uploadArea = document.getElementById("uploadArea");
        const uploadTitle = document.getElementById("uploadTitle");

        const titles = {
          usuarios: "Importar Usuarios",
          notas: "Importar Notas",
          cursos: "Importar Cursos",
          asistencias: "Importar Asistencias",
          profesores: "Importar Profesores",
        };

        uploadTitle.textContent = titles[type];
        uploadArea.classList.add("active");
        resetUpload();
      }

      function hideUpload() {
        document.getElementById("uploadArea").classList.remove("active");
        resetUpload();
      }

      function resetUpload() {
        document.getElementById("fileInput").value = "";
        document.getElementById("fileName").textContent = "";
        document.getElementById("uploadBtn").disabled = true;
        document.getElementById("progressContainer").style.display = "none";
        document.getElementById("statusMessage").style.display = "none";
        selectedFile = null;
      }

      function handleFileSelect(event) {
        const file = event.target.files[0];
        if (file) {
          selectedFile = file;
          document.getElementById(
            "fileName"
          ).textContent = `Archivo seleccionado: ${file.name}`;
          document.getElementById("uploadBtn").disabled = false;
        }
      }

      async function processFile() {
        if (!selectedFile) return;

        const uploadBtn = document.getElementById("uploadBtn");
        const progressContainer = document.getElementById("progressContainer");
        const progressFill = document.getElementById("progressFill");
        const statusMessage = document.getElementById("statusMessage");

        uploadBtn.disabled = true;
        progressContainer.style.display = "block";
        statusMessage.style.display = "none";

        try {
          const data = await readExcelFile(selectedFile);

          if (currentType === "usuarios") {
            await importUsers(data, progressFill, statusMessage);
          } else {
            showMessage(
              statusMessage,
              "info",
              `La importaciï¿½n de ${currentType} estarï¿½ disponible prï¿½ximamente.`
            );
          }
        } catch (error) {
          console.error("Error:", error);
          showMessage(
            statusMessage,
            "error",
            `Error al procesar el archivo: ${error.message}`
          );
        } finally {
          uploadBtn.disabled = false;
        }
      }

      function readExcelFile(file) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();

          reader.onload = function (e) {
            try {
              const data = new Uint8Array(e.target.result);
              const workbook = XLSX.read(data, { type: "array" });
              const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
              const jsonData = XLSX.utils.sheet_to_json(firstSheet);
              resolve(jsonData);
            } catch (error) {
              reject(error);
            }
          };

          reader.onerror = function (error) {
            reject(error);
          };

          reader.readAsArrayBuffer(file);
        });
      }

      async function importUsers(data, progressFill, statusMessage) {
        const total = data.length;
        let processed = 0;
        let errors = [];

        showMessage(statusMessage, "info", `Procesando ${total} usuarios...`);

        for (const row of data) {
          try {
            // Normalizar los nombres de las columnas
            const user = {
              activo: true,
              correo: (row.correo || row.Correo || row.email || row.Email || "")
                .toString()
                .toLowerCase(),
              grado: (row.grado || row.Grado || "").toString(),
              grupo: (row.grupo || row.Grupo || "").toString().toUpperCase(),
              id: (row.id || row.Id || row.ID || "").toString(),
              nombre_completo: (
                row.nombre ||
                row.Nombre ||
                row.nombre_completo ||
                row["Nombre Completo"] ||
                ""
              ).toString(),
              rol: "Estudiante",
              telefono: (
                row.telefono ||
                row.Telefono ||
                row.telefono ||
                ""
              ).toString(),
            };

            // Validar campos requeridos
            if (!user.id || !user.nombre_completo) {
              errors.push(
                `Fila ${processed + 1}: Faltan campos requeridos (ID o Nombre)`
              );
              processed++;
              continue;
            }

            // Usar el ID del Excel como ID del documento
            await window.setDoc(window.doc(window.db, "users", user.id), user);

            processed++;
            const percentage = Math.round((processed / total) * 100);
            progressFill.style.width = percentage + "%";
            progressFill.textContent = percentage + "%";
          } catch (error) {
            errors.push(`Error en fila ${processed + 1}: ${error.message}`);
            processed++;
          }
        }

        // Mostrar resultado final
        if (errors.length === 0) {
          showMessage(
            statusMessage,
            "success",
            ` ${total} usuarios importados exitosamente!`
          );
        } else if (errors.length < total) {
          showMessage(
            statusMessage,
            "success",
            `ï¿½ ${processed - errors.length} usuarios importados. ${
              errors.length
            } errores encontrados.`
          );
          console.error("Errores:", errors);
        } else {
          showMessage(
            statusMessage,
            "error",
            `L No se pudo importar ningï¿½n usuario. Revisa el formato del archivo.`
          );
          console.error("Errores:", errors);
        }
      }

      function showMessage(element, type, message) {
        element.className = "status-message " + type;
        element.textContent = message;
        element.style.display = "block";
      }
    </script>
  </body>
</html>
